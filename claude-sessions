#!/usr/bin/env bash

# Claude Code Session Manager
# Manages Claude Code sessions in iTerm2 using /rename command

set -e

SAVED_SESSIONS_FILE="$HOME/.claude/saved-sessions.json"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored message
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }

# Generate unique session ID
generate_session_id() {
    echo "cs-$(date +%s)-$(openssl rand -hex 3)"
}

# Get working directory of a process
get_process_cwd() {
    local pid="$1"
    lsof -p "$pid" 2>/dev/null | grep cwd | awk '{print $NF}'
}

# Find all Claude TTYs (processes with a terminal)
get_claude_ttys() {
    local scope="$1"  # "current" or "all"
    local iterm_ttys

    if [[ "$scope" == "all" ]]; then
        # Get all TTYs from all iTerm2 windows
        iterm_ttys=$(osascript -e '
tell application "iTerm2"
    set ttyList to {}
    repeat with aWindow in windows
        repeat with aTab in tabs of aWindow
            repeat with aSession in sessions of aTab
                set end of ttyList to tty of aSession
            end repeat
        end repeat
    end repeat
    set AppleScript'"'"'s text item delimiters to ","
    return ttyList as text
end tell')
    else
        # Get TTYs from current iTerm2 window only
        iterm_ttys=$(osascript -e '
tell application "iTerm2"
    set ttyList to {}
    tell current window
        repeat with aTab in tabs
            repeat with aSession in sessions of aTab
                set end of ttyList to tty of aSession
            end repeat
        end repeat
    end tell
    set AppleScript'"'"'s text item delimiters to ","
    return ttyList as text
end tell')
    fi

    # Filter to only TTYs running Claude
    local result=""
    IFS=',' read -ra tty_list <<< "$iterm_ttys"

    for tty in "${tty_list[@]}"; do
        tty=$(echo "$tty" | xargs)
        tty_name=$(basename "$tty" 2>/dev/null)

        if [[ -z "$tty_name" ]]; then
            continue
        fi

        # Check if Claude is running on this TTY
        if ps -t "$tty_name" -o comm= 2>/dev/null | grep -q "^claude$"; then
            if [[ -n "$result" ]]; then
                result="$result $tty"
            else
                result="$tty"
            fi
        fi
    done

    echo "$result"
}

# Send /rename command to a specific TTY via AppleScript
send_rename_to_tty() {
    local tty="$1"
    local session_id="$2"

    osascript <<EOF
tell application "iTerm2"
    repeat with w from 1 to count of windows
        tell window w
            repeat with t from 1 to count of tabs
                tell tab t
                    repeat with s in sessions
                        if tty of s is "$tty" then
                            tell s
                                write text "/rename $session_id" newline NO
                                delay 0.1
                                write text ""
                            end tell
                            return "success"
                        end if
                    end repeat
                end tell
            end repeat
        end tell
    end repeat
    return "not_found"
end tell
EOF
}

# Get Claude PID for a specific TTY
get_claude_pid_for_tty() {
    local tty="$1"
    local tty_name
    tty_name=$(basename "$tty")
    ps -t "$tty_name" -o pid=,comm= 2>/dev/null | grep "claude$" | awk '{print $1}' | head -1
}

# List Claude sessions
cmd_list() {
    local all_flag=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --all|-a)
                all_flag=true
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    print_info "Searching for Claude Code sessions..."

    local scope="current"
    if $all_flag; then
        scope="all"
    fi

    local claude_ttys
    claude_ttys=$(get_claude_ttys "$scope")

    if [[ -z "$claude_ttys" ]]; then
        print_warning "No Claude Code sessions found"
        return
    fi

    echo ""
    printf "%-15s %-50s\n" "TTY" "PROJECT"
    printf "%-15s %-50s\n" "---" "-------"

    local count=0
    for tty in $claude_ttys; do
        local pid
        pid=$(get_claude_pid_for_tty "$tty")

        if [[ -n "$pid" ]]; then
            local cwd
            cwd=$(get_process_cwd "$pid")
            local tty_short
            tty_short=$(basename "$tty")
            printf "%-15s %-50s\n" "$tty_short" "$cwd"
            ((count++))
        fi
    done

    echo ""
    print_success "Found $count Claude Code session(s)"
}

# Save Claude sessions by sending /rename to each
cmd_save() {
    local all_flag=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --all|-a)
                all_flag=true
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    print_info "Saving Claude Code sessions..."

    local scope="current"
    if $all_flag; then
        scope="all"
    fi

    local claude_ttys
    claude_ttys=$(get_claude_ttys "$scope")

    if [[ -z "$claude_ttys" ]]; then
        print_warning "No Claude Code sessions to save"
        return
    fi

    local sessions_json="[]"
    local count=0

    for tty in $claude_ttys; do
        local pid
        pid=$(get_claude_pid_for_tty "$tty")

        if [[ -z "$pid" ]]; then
            continue
        fi

        local cwd
        cwd=$(get_process_cwd "$pid")

        if [[ -z "$cwd" ]]; then
            continue
        fi

        # Generate unique session ID
        local session_id
        session_id=$(generate_session_id)

        print_info "Renaming session in $cwd to $session_id..."

        # Send /rename command
        local result
        result=$(send_rename_to_tty "$tty" "$session_id")

        if [[ "$result" == "success" ]]; then
            # Wait for rename to complete
            sleep 0.5

            sessions_json=$(echo "$sessions_json" | jq --arg sid "$session_id" --arg proj "$cwd" \
                '. + [{"sessionId": $sid, "project": $proj}]')
            ((count++))
            print_success "Saved session $session_id for $cwd"
        else
            print_warning "Could not rename session in $cwd"
        fi
    done

    if [[ $count -eq 0 ]]; then
        print_warning "No sessions were saved"
        return
    fi

    local timestamp
    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    local output
    output=$(jq -n --arg ts "$timestamp" --argjson sessions "$sessions_json" \
        '{"savedAt": $ts, "sessions": $sessions}')

    echo "$output" > "$SAVED_SESSIONS_FILE"

    print_success "Saved $count session(s) to $SAVED_SESSIONS_FILE"
}

# Kill Claude sessions
cmd_kill() {
    local all_flag=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --all|-a)
                all_flag=true
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    # Save sessions first
    print_info "Saving sessions before killing..."
    if $all_flag; then
        cmd_save --all
    else
        cmd_save
    fi

    print_info "Killing Claude Code sessions..."

    local scope="current"
    if $all_flag; then
        scope="all"
    fi

    local claude_ttys
    claude_ttys=$(get_claude_ttys "$scope")

    if [[ -z "$claude_ttys" ]]; then
        print_warning "No Claude Code sessions to kill"
        return
    fi

    local count=0
    for tty in $claude_ttys; do
        local pid
        pid=$(get_claude_pid_for_tty "$tty")

        if [[ -n "$pid" ]]; then
            local cwd
            cwd=$(get_process_cwd "$pid")

            if kill -TERM "$pid" 2>/dev/null; then
                print_success "Killed session in $cwd (PID: $pid)"
                ((count++))
            else
                print_error "Failed to kill PID $pid"
            fi
        fi
    done

    print_success "Killed $count session(s)"
}

# Restore Claude sessions
cmd_restore() {
    if [[ ! -f "$SAVED_SESSIONS_FILE" ]]; then
        print_error "No saved sessions found at $SAVED_SESSIONS_FILE"
        exit 1
    fi

    print_info "Restoring Claude Code sessions..."

    local sessions
    sessions=$(jq -r '.sessions[] | "\(.sessionId)|\(.project)"' "$SAVED_SESSIONS_FILE")

    if [[ -z "$sessions" ]]; then
        print_warning "No sessions to restore"
        return
    fi

    local count=0
    while IFS='|' read -r session_id project; do
        if [[ -z "$session_id" || -z "$project" ]]; then
            continue
        fi

        print_info "Restoring session $session_id in $project"

        # Open new tab in iTerm2 and run claude --resume
        osascript <<EOF
tell application "iTerm2"
    tell current window
        create tab with default profile
        tell current session
            write text "cd '$project' && claude --resume '$session_id'"
        end tell
    end tell
end tell
EOF

        ((count++))

        # Small delay between opening tabs
        sleep 0.5
    done <<< "$sessions"

    print_success "Restored $count session(s)"
}

# Show help
cmd_help() {
    cat <<EOF
Claude Code Session Manager

Usage: claude-sessions <command> [options]

Commands:
  list [--all]     List active Claude Code sessions
                   --all: Include all iTerm2 windows (default: current window only)

  save [--all]     Save active sessions by renaming them with unique IDs
                   --all: Include all iTerm2 windows (default: current window only)
                   Sends /rename command to each active session

  kill [--all]     Kill active sessions (automatically saves first)
                   --all: Include all iTerm2 windows (default: current window only)

  restore          Restore saved sessions in new iTerm2 tabs
                   Uses 'claude --resume <session-id>' for each saved session

  help             Show this help message

Examples:
  claude-sessions list           # List sessions in current window
  claude-sessions list --all     # List all sessions
  claude-sessions save           # Save current window sessions
  claude-sessions kill --all     # Kill all sessions
  claude-sessions restore        # Restore saved sessions

EOF
}

# Main entry point
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        list)
            cmd_list "$@"
            ;;
        save)
            cmd_save "$@"
            ;;
        kill)
            cmd_kill "$@"
            ;;
        restore)
            cmd_restore "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            print_error "Unknown command: $command"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
